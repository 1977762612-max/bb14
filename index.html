<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CASE: THE LAB REPORT</title>
    <style>
        :root {
            /* 现代都市/科技悬疑配色 */
            --bg-paper: #f4f6f8; /* 现代办公文档背景 */
            --ink-black: #2d3436; /* 深灰 */
            --accent-blue: #0984e3; /* 科技蓝 */
            --alert-orange: #d63031; /* 警示红/橙 */
            --font-head: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-body: 'Open Sans', sans-serif;
        }
        body { background-color: #dfe6e9; color: var(--ink-black); font-family: var(--font-body); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; user-select: none; }
        .container { background-color: #fff; width: 90%; max-width: 800px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-top: 5px solid var(--ink-black); position: relative; border-radius: 4px; }
        .hidden { display: none; }
        h1, h2, h3 { font-family: var(--font-head); font-weight: 700; border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--ink-black); letter-spacing: -0.5px; }
        
        .btn { background: var(--ink-black); color: white; padding: 12px 24px; border: none; cursor: pointer; font-family: var(--font-head); margin-top: 15px; font-size: 15px; border-radius: 4px; transition: all 0.2s; font-weight: 600;}
        .btn:hover { background: var(--accent-blue); transform: translateY(-1px); }
        .btn-skip { background: transparent; color: var(--alert-orange); border: 1px dashed var(--alert-orange); padding: 6px 12px; cursor: pointer; font-size: 12px; margin-top: 15px; border-radius: 4px; }
        
        .clue-box { background: #f8f9fa; padding: 20px; border-left: 4px solid var(--accent-blue); margin: 20px 0; line-height: 1.7; font-size: 0.95em; color: #444; }
        
        .profile-card { background: #fff; padding: 15px; margin-bottom: 12px; border: 1px solid #eee; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
        .profile-name { font-weight: bold; color: var(--accent-blue); margin-bottom: 5px; font-size: 1.05em; }
        .profile-motive { color: #636e72; font-size: 0.9em; }

        .loader-track { width: 100%; height: 8px; background: #e0e0e0; margin: 25px 0; overflow: hidden; border-radius: 4px; }
        
        /* 进度条样式 */
        .loader-fill { 
            width: 0%; 
            height: 100%; 
            background: var(--ink-black); 
            border-radius: 4px;
        } 

        /* 动画逻辑 (保持不变) */
        .mode-linear .loader-fill { transition: width 8000ms linear; }
        .mode-fast-start .loader-fill { transition: width 8000ms cubic-bezier(0.1, 0.9, 0.2, 1.0); }
        .mode-peak-end .loader-fill { transition: width 8000ms cubic-bezier(0.8, 0, 0.9, 1); }
        
        #math-challenge { margin-top: 15px; padding: 20px; border: 1px solid #ddd; background: #fafafa; text-align: center; border-radius: 6px; }
        input[type="number"] { padding: 8px; width: 80px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        
        .result-box { padding: 25px; border: 1px solid #eee; margin: 20px 0; background: #fbfbfb; border-radius: 6px; }
        .truth-reveal { font-size: 0.9em; color: #555; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .stamp { font-size: 20px; font-weight: 800; display: inline-block; padding: 5px 12px; border: 2px solid; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; transform: rotate(-3deg); }
        .stamp-success { color: #00b894; border-color: #00b894; }
        .stamp-fail { color: var(--alert-orange); border-color: var(--alert-orange); }
        
        /* 单选框样式优化 */
        label { display: block; margin-bottom: 10px; cursor: pointer; padding: 10px; background: #f9f9f9; border-radius: 4px; transition: background 0.2s; }
        label:hover { background: #eef2f5; }
        input[type="radio"] { margin-right: 10px; }
    </style>
</head>
<body>

<div class="container" id="game-container">
    <div id="stage-intro" class="main-stage">
        <h1>案件：第4实验室爆炸案</h1>
        <p>昨晚 22:15，“云端生物”研发中心的4号实验室发生爆炸，首席科学家林博士当场身亡。警方判定为易燃化学品操作失误，但你作为保险调查员，发现了疑点。</p>
        
        <h3>相关人员笔录摘要</h3>
        <div class="profile-card">
            <span class="profile-name">死者：林博士 (首席科学家)</span>
            <span class="profile-motive">状态：近期精神高度紧张，曾向董事会发送过一封加密邮件（内容未知）。</span>
        </div>
        <div class="profile-card">
            <span class="profile-name">嫌疑人 A：李助理 (博士生)</span>
            <span class="profile-motive">动机：林博士指控他论文造假，不仅要开除他，还要他在行业内混不下去。</span>
        </div>
        <div class="profile-card">
            <span class="profile-name">嫌疑人 B：陈副总 (合伙人)</span>
            <span class="profile-motive">动机：急于推进新药上市圈钱，但林博士坚持药理数据有缺陷，拒绝签字放行。</span>
        </div>
        <div class="profile-card">
            <span class="profile-name">嫌疑人 C：王主管 (安全部经理)</span>
            <span class="profile-motive">动机：负责实验室器材采购和安防。为人圆滑，声称和林博士关系融洽，没有任何利益冲突。</span>
        </div>

        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">系统正在尝试恢复受损的服务器数据...</p>
        <button class="btn" onclick="nextRound()">开始数据恢复</button>
    </div>

    <div id="stage-loading" class="main-stage hidden" onclick="handleFidget(event)">
        <h2 id="loading-title">连接服务器...</h2>
        <div class="loader-track"><div class="loader-fill" id="progBar"></div></div>
        
        <div id="skip-wrapper">
            <button class="btn-skip" onclick="clickSkip()">>> 申请管理员权限 (Admin Override)</button>
        </div>

        <div id="math-challenge" class="hidden">
            <p><strong>安全验证</strong></p>
            <p>检测到异常流量，请输入验证码以继续：</p>
            <span id="math-question" style="font-size: 1.2em; letter-spacing: 2px; font-family: monospace; font-weight: bold;"></span> = 
            <input type="number" id="math-answer">
            <button class="btn" style="padding:8px 20px; margin-left: 10px; margin-top:0;" onclick="checkMath()">验证</button>
        </div>
    </div>

    <div id="stage-clue" class="main-stage hidden">
        <h2 id="clue-meta"></h2>
        <div class="clue-box" id="clue-text"></div>
        <button class="btn" onclick="nextRound()">分析下一条数据</button>
    </div>

    <div id="stage-deduction" class="main-stage hidden">
        <h2>最终调查报告</h2>
        <p>综合恢复的三份数据日志，谁最有可能是制造这场“意外”的真凶？</p>
        <label><input type="radio" name="suspect" value="李助理"> 李助理 (为前途杀人)</label>
        <label><input type="radio" name="suspect" value="陈副总"> 陈副总 (为利益杀人)</label>
        <label><input type="radio" name="suspect" value="王主管"> 王主管 (安全主管)</label>
        <button class="btn" onclick="submitVerdict()">提交结案报告</button>
    </div>

    <div id="stage-result" class="main-stage hidden">
        <div id="result-header"></div>
        <div class="result-box">
            <p id="result-message"></p>
            <div class="truth-reveal">
                <h3>案情复盘</h3>
                <p><strong>真凶：王主管 (安全经理)</strong></p>
                <p>1. <strong>核心矛盾</strong>：虽然李助理和陈副总都有杀人动机，但他们没有作案能力。爆炸源于“通风系统关闭”导致的化学气体积聚。只有安全主管有权限在不触发警报的情况下，远程关闭特定实验室的通风阀。</p>
                <p>2. <strong>关键线索</strong>：恢复的采购单（日志I）显示，王主管长期采购廉价劣质的过滤阀，并通过虚报价格贪污差价。林博士生前发送的加密邮件（日志III）正是关于设备故障的投诉。王主管为了掩盖贪污证据，企图制造一场小火灾销毁设备，却导致了爆炸。</p>
                <p>3. <strong>不在场证明的漏洞</strong>：门禁记录（日志II）显示案发时无人进出，这是王主管最得意的布局——他利用远程权限作案，根本不需要出现在现场。</p>
            </div>
        </div>
        <button class="btn" onclick="goToExport()">生成实验数据</button>
    </div>

    <div id="stage-export" class="main-stage hidden">
        <h2>数据已归档</h2>
        <p>请复制下方代码，粘贴到问卷的<strong>第一题</strong>中：</p>
        <textarea id="final-data" style="width:100%; height:200px; font-family:monospace; padding:10px; font-size: 12px; background:#f4f6f8; border:1px solid #ddd;" readonly></textarea>
        <br><br>
        <button class="btn" id="copy-btn" onclick="copyData()">复制数据</button>
    </div>
</div>

<script>
    // --- 游戏文案配置 (现代悬疑版) ---
    const clues = [
        { meta: "数据碎片 I：后台采购单", text: "已恢复一份被删除的 Excel。数据显示，过去一年实验室的‘空气过滤阀’采购价格，比市场价高出 300%，但供应商却是一家注册在海外的空壳公司。该采购流程的最终审批人签字是：王主管。" },
        { meta: "数据碎片 II：门禁日志", text: "案发当晚 21:00 至 23:00，4号实验室没有人员进出记录。但是，系统日志显示，22:10（爆炸前5分钟），实验室的智能通风系统接收到了一条‘强制休眠’指令。该指令发出的 IP 地址来自公司内部的安防监控室。" },
        { meta: "数据碎片 III：死者草稿箱", text: "林博士的邮箱草稿箱里有一封未发出的邮件，收件人是审计署。标题是《关于安防设备严重老化及经费去向不明的举报材料》。附件是一份详细的设备检测报告，证明目前的安防设备根本无法通过验收。" }
    ];
    
    // 加载界面的文案
    const loadingTexts = [
        "正在恢复：财务部隐秘账目 (1/3)...",
        "正在解析：安防系统操作日志 (2/3)...",
        "正在解密：死者云端草稿箱 (3/3)..."
    ];
    
    // 数学题 (保持简单)
    const mathQs = [ {q: "15 + 25", a: 40}, {q: "50 - 15", a: 35}, {q: "8 x 6", a: 48} ];

    let currentRound = 0;
    
    // --- 核心逻辑 (保持不变) ---
    const urlParams = new URLSearchParams(window.location.search);
    const assignedGroup = urlParams.get('g') ? parseInt(urlParams.get('g')) : Math.floor(Math.random() * 3) + 1;

    let experimentData = {
        group: assignedGroup, 
        rounds: [], 
        finalChoice: "",
        isCorrect: false,
        startTime: Date.now()
    };

    let waitStartTime, waitTimeout, currentVerifErrors = 0, currentFidgetClicks = 0, currentClickSkipTime = null;

    function nextRound() {
        if (currentRound < clues.length) {
            startWaiting();
        } else {
            switchStage('stage-deduction');
        }
    }

    function startWaiting() {
        if (waitTimeout) clearTimeout(waitTimeout);
        
        switchStage('stage-loading');
        
        if (currentRound < loadingTexts.length) {
            document.getElementById('loading-title').innerText = loadingTexts[currentRound];
        }

        const bar = document.getElementById('progBar');
        const container = document.getElementById('stage-loading');
        
        document.getElementById('math-challenge').classList.add('hidden');
        document.getElementById('skip-wrapper').classList.remove('hidden');
        document.getElementById('math-answer').value = "";

        // 重置动画状态
        container.classList.remove('mode-linear', 'mode-fast-start', 'mode-peak-end');
        bar.style.transition = 'none'; 
        bar.style.width = "0%";
        
        // 强制重绘
        void bar.offsetWidth; 
        bar.style.transition = ''; 

        // 延迟触发
        setTimeout(() => {
            if (experimentData.group === 1) container.classList.add('mode-linear');
            else if (experimentData.group === 2) container.classList.add('mode-fast-start');
            else if (experimentData.group === 3) container.classList.add('mode-peak-end');
            
            bar.style.width = "100%";
        }, 50);

        waitStartTime = Date.now();
        currentVerifErrors = 0;
        currentFidgetClicks = 0;
        currentClickSkipTime = null;

        waitTimeout = setTimeout(() => {
            finishWaiting(false);
        }, 8000);
    }

    function handleFidget(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
        currentFidgetClicks++;
    }

    function clickSkip() {
        if (currentClickSkipTime === null) {
            currentClickSkipTime = Date.now() - waitStartTime;
        }

        document.getElementById('math-question').innerText = mathQs[currentRound].q;
        document.getElementById('skip-wrapper').classList.add('hidden');
        document.getElementById('math-challenge').classList.remove('hidden');
    }

    function checkMath() {
        const val = parseInt(document.getElementById('math-answer').value);
        if (val === mathQs[currentRound].a) {
            clearTimeout(waitTimeout); 
            const bar = document.getElementById('progBar');
            bar.style.transition = 'width 200ms ease-out';
            bar.style.width = "100%";
            setTimeout(() => { finishWaiting(true); }, 200); 
        } else {
            currentVerifErrors++;
            alert("验证码错误");
            document.getElementById('math-answer').value = "";
        }
    }

    function finishWaiting(skipped) {
        if (waitTimeout) clearTimeout(waitTimeout);
        
        experimentData.rounds.push({
            round: currentRound + 1,
            skipped: skipped,
            verifErrors: currentVerifErrors,
            waitTime_ms: Date.now() - waitStartTime, 
            fidgetClicks: currentFidgetClicks,
            timeToClickSkip_ms: currentClickSkipTime 
        });
        
        document.getElementById('clue-meta').innerText = clues[currentRound].meta;
        document.getElementById('clue-text').innerText = clues[currentRound].text;
        switchStage('stage-clue');
        currentRound++;
    }

    function submitVerdict() {
        const sel = document.querySelector('input[name="suspect"]:checked');
        if (!sel) return alert("请选择一名嫌疑人");
        experimentData.finalChoice = sel.value;
        experimentData.isCorrect = (sel.value === "王主管");
        
        const header = document.getElementById('result-header');
        const msg = document.getElementById('result-message');
        if (experimentData.isCorrect) {
            header.innerHTML = '<div class="stamp stamp-success">判定准确</div>';
            msg.innerText = "非常敏锐。你没有被显眼的情感矛盾误导，而是抓住了背后隐藏的利益链条。";
        } else {
            header.innerHTML = '<div class="stamp stamp-fail">判定错误</div>';
            msg.innerText = "很遗憾。真正的凶手是王主管。你可能过度关注了显性的杀人动机，而忽略了隐性的职务犯罪线索。";
        }
        switchStage('stage-result');
    }

    function goToExport() {
        document.getElementById('final-data').value = JSON.stringify(experimentData, null, 2);
        switchStage('stage-export');
    }

    function switchStage(id) {
        document.querySelectorAll('.main-stage').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function copyData() {
        const txt = document.getElementById('final-data');
        txt.select(); document.execCommand('copy');
        document.getElementById('copy-btn').innerText = "✅ 已复制";
    }
</script>
</body>
</html>
